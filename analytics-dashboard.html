<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>A1 Diagnosis - Analytics Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f8fafc;
            color: #1e293b;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            background: linear-gradient(135deg, #0ea5e9 0%, #0284c7 100%);
            color: white;
            padding: 2rem;
            border-radius: 16px;
            margin-bottom: 2rem;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }
        
        .header p {
            opacity: 0.9;
            font-size: 1.1rem;
        }
        
        .controls {
            background: white;
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            margin-bottom: 2rem;
            display: flex;
            gap: 1rem;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .controls label {
            font-weight: 600;
            color: #374151;
        }
        
        .controls select, .controls button {
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 14px;
        }
        
        .controls button {
            background: linear-gradient(135deg, #0ea5e9 0%, #0284c7 100%);
            color: white;
            border: none;
            cursor: pointer;
            font-weight: 600;
            transition: transform 0.2s ease;
        }
        
        .controls button:hover {
            transform: translateY(-1px);
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .stat-card {
            background: white;
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            text-align: center;
            transition: transform 0.2s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-2px);
        }
        
        .stat-number {
            font-size: 2.5rem;
            font-weight: 800;
            color: #0ea5e9;
            display: block;
            margin-bottom: 0.5rem;
        }
        
        .stat-label {
            color: #64748b;
            font-weight: 500;
        }
        
        .sections-chart, .detailed-data {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            margin-bottom: 2rem;
        }
        
        .sections-chart h3, .detailed-data h3 {
            margin-bottom: 1.5rem;
            color: #1e293b;
            font-size: 1.3rem;
        }
        
        .section-bar {
            display: flex;
            align-items: center;
            margin-bottom: 1rem;
            padding: 0.75rem;
            background: #f8fafc;
            border-radius: 8px;
        }
        
        .section-name {
            width: 120px;
            font-weight: 600;
            color: #374151;
            text-transform: capitalize;
        }
        
        .section-progress {
            flex: 1;
            height: 8px;
            background: #e2e8f0;
            border-radius: 4px;
            margin: 0 1rem;
            overflow: hidden;
        }
        
        .section-fill {
            height: 100%;
            background: linear-gradient(90deg, #0ea5e9, #0284c7);
            border-radius: 4px;
            transition: width 0.3s ease;
        }
        
        .section-time {
            width: 80px;
            text-align: right;
            font-weight: 600;
            color: #64748b;
        }
        
        .loading {
            text-align: center;
            padding: 3rem;
            color: #64748b;
        }
        
        .error {
            background: #fef2f2;
            color: #dc2626;
            padding: 1rem;
            border-radius: 8px;
            border-left: 4px solid #dc2626;
            margin-bottom: 1rem;
        }
        
        .sessions-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }
        
        .sessions-table th,
        .sessions-table td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .sessions-table th {
            background: #f8fafc;
            font-weight: 600;
            color: #374151;
        }
        
        .device-badge {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .device-mobile { background: #fef3c7; color: #92400e; }
        .device-tablet { background: #dbeafe; color: #1e40af; }
        .device-desktop { background: #ecfdf5; color: #065f46; }
        
        .engagement-score {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-weight: 600;
            color: white;
        }
        
        .engagement-low { background: #dc2626; }
        .engagement-medium { background: #f59e0b; }
        .engagement-high { background: #10b981; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>A1 Diagnosis Analytics Dashboard</h1>
            <p>Real-time section viewing analytics and user behavior insights</p>
        </div>
        
        <div class="controls">
            <label for="timeRange">Time Range:</label>
            <select id="timeRange">
                <option value="1">Last 24 hours</option>
                <option value="7" selected>Last 7 days</option>
                <option value="30">Last 30 days</option>
                <option value="90">Last 90 days</option>
            </select>
            
            <label for="dataFormat">View:</label>
            <select id="dataFormat">
                <option value="summary" selected>Summary</option>
                <option value="detailed">Detailed</option>
            </select>
            
            <button onclick="loadAnalytics()">üîÑ Refresh</button>
            <button onclick="exportData()">üìä Export CSV</button>
        </div>
        
        <div id="error-container"></div>
        
        <div id="loading" class="loading">
            <p>üìä Loading analytics data...</p>
        </div>
        
        <div id="analytics-content" style="display: none;">
            <div class="stats-grid">
                <div class="stat-card">
                    <span id="total-sessions" class="stat-number">0</span>
                    <span class="stat-label">Total Sessions</span>
                </div>
                <div class="stat-card">
                    <span id="avg-time" class="stat-number">0s</span>
                    <span class="stat-label">Average Time</span>
                </div>
                <div class="stat-card">
                    <span id="bounce-rate" class="stat-number">0%</span>
                    <span class="stat-label">Bounce Rate</span>
                </div>
                <div class="stat-card">
                    <span id="engagement-rate" class="stat-number">0%</span>
                    <span class="stat-label">High Engagement</span>
                </div>
            </div>
            
            <div class="sections-chart">
                <h3>üìç Section Performance</h3>
                <div id="sections-data">
                    <!-- Section bars will be populated here -->
                </div>
            </div>
            
            <div class="detailed-data">
                <h3>üì± Device & Engagement Breakdown</h3>
                <div id="device-data">
                    <!-- Device statistics will be populated here -->
                </div>
                
                <div id="sessions-detail" style="display: none;">
                    <h4>Recent Sessions</h4>
                    <table class="sessions-table">
                        <thead>
                            <tr>
                                <th>Session ID</th>
                                <th>Timestamp</th>
                                <th>Duration</th>
                                <th>Sections</th>
                                <th>Device</th>
                                <th>Engagement</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="sessions-tbody">
                            <!-- Session data will be populated here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentData = null;
        
        async function loadAnalytics() {
            const timeRange = document.getElementById('timeRange').value;
            const dataFormat = document.getElementById('dataFormat').value;
            
            const loadingEl = document.getElementById('loading');
            const contentEl = document.getElementById('analytics-content');
            const errorEl = document.getElementById('error-container');
            
            loadingEl.style.display = 'block';
            contentEl.style.display = 'none';
            errorEl.innerHTML = '';
            
            try {
                const response = await fetch(`/.netlify/functions/user-analytics?days=${timeRange}&format=${dataFormat}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                currentData = data;
                
                if (data.success) {
                    displayAnalytics(data.analytics, dataFormat);
                } else {
                    throw new Error('Failed to load analytics data');
                }
                
            } catch (error) {
                console.error('Error loading analytics:', error);
                errorEl.innerHTML = `
                    <div class="error">
                        <strong>Error loading analytics:</strong> ${error.message}
                        <br><small>Make sure the Netlify function is deployed and accessible.</small>
                    </div>
                `;
            } finally {
                loadingEl.style.display = 'none';
                contentEl.style.display = 'block';
            }
        }
        
        function displayAnalytics(analytics, format) {
            // Update summary stats
            document.getElementById('total-sessions').textContent = analytics.summary?.total_sessions || 0;
            document.getElementById('avg-time').textContent = formatTime(analytics.summary?.average_time_seconds || 0);
            document.getElementById('bounce-rate').textContent = Math.round(analytics.summary?.bounce_rate || 0) + '%';
            document.getElementById('engagement-rate').textContent = Math.round(analytics.engagement?.engagement_rate || 0) + '%';
            
            // Display sections data
            displaySectionsData(analytics.sections || {});
            
            // Display device data
            displayDeviceData(analytics.devices || {}, analytics.engagement || {});
            
            // Show detailed sessions if available
            if (format === 'detailed' && analytics.detailed_sessions) {
                displayDetailedSessions(analytics.detailed_sessions);
                document.getElementById('sessions-detail').style.display = 'block';
            } else {
                document.getElementById('sessions-detail').style.display = 'none';
            }
        }
        
        function displaySectionsData(sections) {
            const container = document.getElementById('sections-data');
            
            if (Object.keys(sections).length === 0) {
                container.innerHTML = '<p>No section data available yet.</p>';
                return;
            }
            
            // Sort sections by average time
            const sortedSections = Object.entries(sections)
                .sort(([,a], [,b]) => (b.average_time || 0) - (a.average_time || 0));
            
            const maxTime = Math.max(...sortedSections.map(([,s]) => s.average_time || 0));
            
            container.innerHTML = sortedSections.map(([name, data]) => {
                const percentage = maxTime > 0 ? (data.average_time / maxTime) * 100 : 0;
                
                return `
                    <div class="section-bar">
                        <div class="section-name">${name}</div>
                        <div class="section-progress">
                            <div class="section-fill" style="width: ${percentage}%"></div>
                        </div>
                        <div class="section-time">${formatTime(data.average_time_seconds)}</div>
                    </div>
                `;
            }).join('');
        }
        
        function displayDeviceData(devices, engagement) {
            const container = document.getElementById('device-data');
            
            if (Object.keys(devices).length === 0) {
                container.innerHTML = '<p>No device data available yet.</p>';
                return;
            }
            
            const total = Object.values(devices).reduce((sum, count) => sum + count, 0);
            
            container.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1rem;">
                    ${Object.entries(devices).map(([device, count]) => {
                        const percentage = Math.round((count / total) * 100);
                        return `
                            <div style="text-align: center;">
                                <div class="device-badge device-${device}">${device}</div>
                                <div style="margin-top: 0.5rem; font-size: 1.2rem; font-weight: 600;">${count} (${percentage}%)</div>
                            </div>
                        `;
                    }).join('')}
                </div>
                <div style="padding: 1rem; background: #f8fafc; border-radius: 8px;">
                    <strong>Engagement Metrics:</strong><br>
                    Average Score: ${engagement.average_score || 0}/100<br>
                    High Engagement Sessions: ${engagement.high_engagement_sessions || 0}
                </div>
            `;
        }
        
        function displayDetailedSessions(sessions) {
            const tbody = document.getElementById('sessions-tbody');
            
            tbody.innerHTML = sessions.slice(0, 20).map(session => `
                <tr>
                    <td><code>${session.id.substring(0, 12)}...</code></td>
                    <td>${new Date(session.timestamp).toLocaleString()}</td>
                    <td>${formatTime(session.duration_seconds)}</td>
                    <td>${session.sections_visited}</td>
                    <td><span class="device-badge device-${session.device}">${session.device}</span></td>
                    <td><span class="engagement-score engagement-${getEngagementLevel(session.engagement_score)}">${session.engagement_score}</span></td>
                    <td>
                        ${session.viewed_presentation ? 'üéØ Presentation' : ''}
                        ${session.contact_engagement ? 'üìß Contact' : ''}
                    </td>
                </tr>
            `).join('');
        }
        
        function formatTime(seconds) {
            if (seconds < 60) return seconds + 's';
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = seconds % 60;
            return `${minutes}m ${remainingSeconds}s`;
        }
        
        function getEngagementLevel(score) {
            if (score >= 70) return 'high';
            if (score >= 40) return 'medium';
            return 'low';
        }
        
        function exportData() {
            if (!currentData) {
                alert('No data to export. Please load analytics first.');
                return;
            }
            
            // Create CSV content
            let csv = 'Section,Views,Average Time (seconds),Engagement Rate\n';
            
            if (currentData.analytics.sections) {
                Object.entries(currentData.analytics.sections).forEach(([name, data]) => {
                    csv += `${name},${data.total_views},${data.average_time_seconds},${data.engagement_rate}%\n`;
                });
            }
            
            // Download CSV
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `a1-diagnosis-analytics-${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }
        
        // Event listeners
        document.getElementById('timeRange').addEventListener('change', loadAnalytics);
        document.getElementById('dataFormat').addEventListener('change', loadAnalytics);
        
        // Test function deployment first
        async function testFunction() {
            try {
                console.log('üß™ Testing Netlify function deployment...');
                const response = await fetch('/.netlify/functions/test');
                const data = await response.json();
                console.log('‚úÖ Test function result:', data);
                return true;
            } catch (error) {
                console.error('‚ùå Test function failed:', error);
                return false;
            }
        }

        // Load analytics on page load
        document.addEventListener('DOMContentLoaded', async () => {
            // Test function deployment first
            const testPassed = await testFunction();
            if (testPassed) {
                console.log('‚úÖ Functions are deployed, loading analytics...');
                loadAnalytics();
            } else {
                console.log('‚ö†Ô∏è Function test failed, trying analytics anyway...');
                loadAnalytics();
            }
        });
        
        // Auto-refresh every 5 minutes
        setInterval(loadAnalytics, 5 * 60 * 1000);
    </script>
</body>
</html>